####{ CreativeBC }####| Light associated with a Motion Sensor |####[ github.com/wfurphy/creative-button-card-templates ]####>
####:::Changes 0.3:::> Added `active_entity` functionality
light_motion:
  template:
    - light
  color: auto
  variables:
    motion_entity:
    active_entity:
    timer_entity:
    __pauseState: >
      [[[
        return function(timer_entity, entity) {
          const ps = {
            custom_field: 'motion',
            timer_state: states[timer_entity]?.state,
            display: {
              label: 'none',
              motion: 'block',
              timer: 'none'
            }
          }
          
          if (timer_entity) {
            if(states[timer_entity].state == 'active') {
              ps.custom_field = 'timer'
              ps.display.motion = 'none'
              ps.display.timer = 'block'
            }
          }

          if (entity.state == 'on') {
            ps.areas = `\"i i n\" \"i i l\" \"i i ${ps.custom_field}\"`
            ps.rows = '1fr 1fr 1fr'
            ps.display.label = 'block'
          } else {
            ps.areas =  `\"i i n\" \"i i ${ps.custom_field}\"`
            ps.rows = '1fr 1fr'
          }

          return ps
        }
      ]]]
  triggers_update:
    - "[[[ return variables.motion_entity ]]]"
    - "[[[ return variables.timer_entity ]]]"
    - "[[[ return variables.active_entity ]]]"
  styles:
    grid:
      - grid-template-areas: "[[[ return variables.__pauseState(variables.timer_entity, entity).areas ]]]"
      - grid-template-columns: 1fr 1fr 4fr
      - grid-template-rows: "[[[ return variables.__pauseState(variables.timer_entity, entity).rows ]]]"
      - justify-items: start
      - padding: 6px
    name:
      - line-height: 22px
    label:
      - display: "[[[ return variables.__pauseState(variables.timer_entity, entity).display.label ]]]"
      - align-self: center
    custom_fields:
      motion:
        - justify-self: start
        - align-self: start
        - text-align: left
        - display: "[[[ return variables.__pauseState(variables.timer_entity, entity).display.motion ]]]"
      timer:
        - justify-self: start
        - align-self: start
        - text-align: left
        - display: "[[[ return variables.__pauseState(variables.timer_entity, entity).display.timer ]]]"
  custom_fields:
    motion:
      card:
        type: custom:button-card
        template: transparent
        entity: "[[[ return variables.motion_entity ]]]"
        show_name: false
        show_last_changed: true
        triggers_update:
          - "[[[ return variables.motion_entity ]]]"
          - "[[[ return variables.timer_entity ]]]"
          - "[[[ return variables.active_entity ]]]"
        tap_action:
          action: "[[[ return variables.active_entity ? 'call-service' : 'none' ]]]"
          service: input_boolean.toggle
          target:
            entity_id: "[[[ return variables.active_entity || '' ]]]"
        double_tap_action: none #:::TODO::> Add ability to pause with timer on tap and move stop to here.
        state:
          - id: cbc_motion_active
            operator: template
            value: >
              [[[ 
                // const mstate = variables.active_entity ? states[variables.active_entity].state : 'none'
                // console.log(variables.active_entity, mstate, variables.active_entity && states[variables.active_entity].state == 'off', { bc: this })
                
                return variables.active_entity && states[variables.active_entity].state == 'off'
              ]]]
            icon: mdi:motion-sensor-off
            styles:
              icon:
                - opactiy: 0.8
                - color: "#C62F48"
          - id: cbc_on
            value: "on"
            icon: mdi:run-fast
            styles:
              icon:
                - opactiy: 0.8
        icon: mdi:run
        # icon: >
        #   [[[
        #     if (!variables.active_entity || states[variables.active_entity].state == 'on') {
        #       return 
        #     }
        #   ]]]
        styles:
          card:
            - overflow: visible
            - margin-left: -2px
            - padding: 0
            - z-index: 3
          grid:
            - grid-template-areas: '"i l"'
            - grid-template-columns: 1fr 3fr
            - grid-template-rows: 1fr
            - padding: 0
          label:
            - overflow: visible
            - justify-self: start
            - align-self: center
            - font-size: 80%
            - margin: 2px 0 0 -2px
            - text-align: left
            - opacity: 0.4
          icon:
            - width: 22px
            - height: 22px
            - padding-right: 5px
            - z-index: 2
            - opacity: "[[[ return variables.active_entity && states[variables.active_entity].state == 'off' ? 0.8 : 0.4 ]]]"
          custom_fields:
            sc:
              - width: 0px;
              - height: 0px;
              - visibility: hidden
        custom_fields:
          sc: >
            [[[
                let content = ''
                if (variables.active_entity) {
                  content = states[variables.active_entity].state == 'off' ? '▶︎' : 'II'
                }

                return `
                  <style>
                    :host {
                      --cbc-hover-content: '${content}';
                    }
                  </style>`
            ]]]
        card_mod:
          style: |
            ha-card:hover::after {
              display: block;
              position:absolute;
              top: 0;
              left: 0;
              width: 100%;
              height: 100%;
              background: rgba(255,255,255,0.03);
              content: '';
              z-index: 1;
            }
            ha-card:hover #img-cell::after {
              display: block;
              position: absolute;
              content: var(--cbc-hover-content);
              top: 0;
              left: 0;
              width: 60%;
              height: 60%;
              margin: auto;
              font-weight: bold;
              z-index: 3;
              text-align: center;
              justify-self: center;
              align-self: center;
            }
    timer:
      card:
        type: custom:button-card
        template: transparent
        entity: "[[[ return variables.timer_entity ]]]"
        triggers_update:
          - "[[[ return variables.motion_entity ]]]"
          - "[[[ return variables.timer_entity ]]]"
          - "[[[ return variables.active_entity ]]]"
        show_state: true
        show_name: false
        show_icon: true
        show_label: true
        label: " remaining"
        styles:
          card:
            - overflow: visible
            - opacity: 0.6
            # - padding: 0
          grid:
            - grid-template-areas: '"i s l"'
            - grid-template-rows: 1fr
          label:
            - overflow: visible
            - justify-self: start
            - align-self: center
            - font-size: 75%
            - margin: 2px 0 0 5px
            - text-align: left
          state:
            - overflow: visible
            - justify-self: start
            - align-self: center
            - font-size: 75%
            - margin: 2px 0 0 -2px
            - text-align: left
            - width: min-content
          icon:
            - width: 18px
            - padding-right: 5px
            - color: rgba(254, 190, 110, 1)

#########################################################################/
  